name: Docker Build & Test

on:
  pull_request:
    paths:
      - 'docker/**'
      - '.github/workflows/docker-build.yml'
  push:
    branches:
      - main
    paths:
      - 'docker/**'

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create required env files
        run: |
          mkdir -p docker/env docker/user_configs

          cat > docker/env/r2r.env << EOF
          OPENAI_API_KEY=sk-test-fake-key-for-ci
          EOF

          cat > docker/env/r2r-full.env << EOF
          OPENAI_API_KEY=sk-test-fake-key-for-ci
          R2R_CONFIG_PATH=/app/user_configs/r2r.toml
          EOF

          cat > docker/env/postgres.env << EOF
          POSTGRES_PASSWORD=test_password_12345
          POSTGRES_USER=postgres
          POSTGRES_DB=r2r
          EOF

          cat > docker/env/minio.env << EOF
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin123
          EOF

          cat > docker/env/hatchet.env << EOF
          DATABASE_URL=postgres://hatchet:hatchet@hatchet-postgres:5432/hatchet
          POSTGRES_USER=hatchet
          POSTGRES_PASSWORD=hatchet
          POSTGRES_DB=hatchet
          RABBITMQ_DEFAULT_USER=hatchet
          RABBITMQ_DEFAULT_PASS=hatchet
          SERVER_GRPC_BROADCAST_ADDRESS=hatchet-engine:7077
          EOF

          cat > docker/env/r2r-dashboard.env << EOF
          NEXT_PUBLIC_API_URL=http://localhost:7272
          EOF

          cat > docker/user_configs/r2r.toml << EOF
          [app]
          project_name = "r2r-ci-test"

          [embedding]
          provider = "litellm"
          base_model = "openai/text-embedding-3-small"
          base_dimension = 1536

          [ingestion]
          chunking_strategy = "by_title"
          EOF

      - name: Validate compose files syntax
        run: |
          docker compose -f docker/compose.full.yaml config > /dev/null
          docker compose -f docker/compose.yaml config > /dev/null
          echo "Docker Compose files are valid"
