name: Docker Build & Test

on:
  pull_request:
    paths:
      - 'docker/**'
      - '.github/workflows/docker-build.yml'
  push:
    branches:
      - main
    paths:
      - 'docker/**'

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  validate-compose:
    name: Validate Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate compose files syntax
        run: |
          docker compose -f docker/compose.full.yaml config > /dev/null
          docker compose -f docker/compose.yaml config > /dev/null
          echo "✅ Docker Compose files are valid"

  build-test:
    name: Build and Test R2R Stack
    runs-on: ubuntu-latest
    needs: validate-compose
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v5
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create test environment files
        run: |
          mkdir -p docker/env

          cat > docker/env/r2r.env << EOF
          # CI test credentials - DO NOT USE IN PRODUCTION
          OPENAI_API_KEY=sk-test-fake-key-for-ci
          ANTHROPIC_API_KEY=sk-ant-test-fake-key-for-ci
          EOF

          cat > docker/env/postgres.env << EOF
          POSTGRES_PASSWORD=test_password_12345
          POSTGRES_USER=postgres
          POSTGRES_DB=r2r
          EOF

          cat > docker/env/minio.env << EOF
          MINIO_ROOT_USER=minioadmin
          MINIO_ROOT_PASSWORD=minioadmin123
          EOF

      - name: Start R2R stack
        run: |
          cd docker
          docker compose -f compose.full.yaml --profile postgres --profile minio up -d

      - name: List running containers
        run: docker ps --format 'table {{.Names}}\t{{.Status}}'

      - name: Wait for services
        run: |
          echo "Waiting 60 seconds for services to start..."
          sleep 60

      - name: Check service health
        run: |
          # Check PostgreSQL
          docker exec r2r-docker-full-postgres-1 pg_isready -U postgres || exit 1
          echo "✅ PostgreSQL is ready"

          # Check MinIO
          curl -f http://localhost:9000/minio/health/live || exit 1
          echo "✅ MinIO is healthy"

          # Check R2R health endpoint (with retries)
          for i in {1..10}; do
            if curl -f http://localhost:7272/v3/health; then
              echo "✅ R2R is healthy"
              exit 0
            fi
            echo "Attempt $i: R2R not ready, waiting..."
            sleep 10
          done
          echo "❌ R2R failed to become healthy"
          docker logs r2r-docker-full-r2r-1 --tail=100
          exit 1

      - name: Run basic API tests
        run: |
          # Test health endpoint
          response=$(curl -s http://localhost:7272/v3/health)
          echo "$response" | jq -e '.status == "healthy"' || exit 1

          echo "✅ All API tests passed"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== R2R Logs ==="
          docker logs r2r-docker-full-r2r-1 --tail=200

          echo "=== PostgreSQL Logs ==="
          docker logs r2r-docker-full-postgres-1 --tail=100

          echo "=== MinIO Logs ==="
          docker logs r2r-docker-full-minio-1 --tail=100

      - name: Cleanup
        if: always()
        run: |
          cd docker
          docker compose -f compose.full.yaml down -v
