name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="$REF_NAME"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Creating release for $TAG"

      - name: Validate tag format
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Invalid tag format: $TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "Tag format valid: $TAG"

      - name: Get previous tag
        id: prev_tag
        env:
          CURRENT_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Generate changelog
        env:
          TAG: ${{ steps.tag.outputs.tag }}
          PREV_TAG: ${{ steps.prev_tag.outputs.prev_tag }}
        run: |
          echo "Generating changelog from $PREV_TAG to $TAG"
          git log "$PREV_TAG".."$TAG" --pretty=format:"%s (%h)" > all_commits.txt || true

          cat > CHANGELOG.md << 'HEADER'
          # Changelog

          HEADER

          if [ -s all_commits.txt ]; then
            FEATURES=$(grep "^feat" all_commits.txt | sed 's/^/- /' || true)
            if [ -n "$FEATURES" ]; then
              echo "## Features" >> CHANGELOG.md
              echo "$FEATURES" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi

            FIXES=$(grep "^fix" all_commits.txt | sed 's/^/- /' || true)
            if [ -n "$FIXES" ]; then
              echo "## Bug Fixes" >> CHANGELOG.md
              echo "$FIXES" >> CHANGELOG.md
              echo "" >> CHANGELOG.md
            fi

            OTHER=$(grep -vE "^(feat|fix)" all_commits.txt | sed 's/^/- /' || true)
            if [ -n "$OTHER" ]; then
              echo "## Other Changes" >> CHANGELOG.md
              echo "$OTHER" >> CHANGELOG.md
            fi
          else
            echo "No commits found in range" >> CHANGELOG.md
          fi

          rm -f all_commits.txt
          cat CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          echo "## Release $TAG Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          cat CHANGELOG.md >> $GITHUB_STEP_SUMMARY
