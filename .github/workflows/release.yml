name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Determine tag
        id: tag
        env:
          INPUT_TAG: ${{ inputs.tag }}
          EVENT_NAME: ${{ github.event_name }}
          REF_NAME: ${{ github.ref_name }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            TAG="$INPUT_TAG"
          else
            TAG="$REF_NAME"
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Creating release for $TAG"

      - name: Validate tag format
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "âŒ Invalid tag format: $TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Tag format valid: $TAG"

      - name: Get previous tag
        id: prev_tag
        env:
          CURRENT_TAG: ${{ steps.tag.outputs.tag }}
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, using initial commit"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Previous tag: $PREV_TAG"

      - name: Generate changelog
        id: changelog
        env:
          TAG: ${{ steps.tag.outputs.tag }}
          PREV_TAG: ${{ steps.prev_tag.outputs.prev_tag }}
        run: |
          echo "Generating changelog from $PREV_TAG to $TAG"

          # Get all commits
          git log $PREV_TAG..$TAG --pretty=format:"%s (%h)" > all_commits.txt

          # Create changelog header
          cat > CHANGELOG.md << 'EOF'
          # Changelog

          EOF

          # Features
          FEATURES=$(grep "^feat" all_commits.txt | sed 's/^/- /' || true)
          if [ -n "$FEATURES" ]; then
            echo "## Features" >> CHANGELOG.md
            echo "$FEATURES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Bug Fixes
          FIXES=$(grep "^fix" all_commits.txt | sed 's/^/- /' || true)
          if [ -n "$FIXES" ]; then
            echo "## Bug Fixes" >> CHANGELOG.md
            echo "$FIXES" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Configuration
          CONFIGS=$(grep "^config" all_commits.txt | sed 's/^/- /' || true)
          if [ -n "$CONFIGS" ]; then
            echo "## Configuration" >> CHANGELOG.md
            echo "$CONFIGS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Documentation
          DOCS=$(grep "^docs" all_commits.txt | sed 's/^/- /' || true)
          if [ -n "$DOCS" ]; then
            echo "## Documentation" >> CHANGELOG.md
            echo "$DOCS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          # Other Changes (exclude feat, fix, config, docs)
          OTHER=$(grep -vE "^(feat|fix|config|docs)" all_commits.txt | sed 's/^/- /' || true)
          if [ -n "$OTHER" ]; then
            echo "## Other Changes" >> CHANGELOG.md
            echo "$OTHER" >> CHANGELOG.md
          fi

          # Cleanup
          rm all_commits.txt

          # Display changelog
          echo "ðŸ“ Generated changelog:"
          cat CHANGELOG.md

      - name: Prepare release artifacts
        run: |
          mkdir -p release-artifacts

          # Copy configuration files
          cp docker/user_configs/r2r.toml release-artifacts/r2r.toml
          cp compose.full.yaml release-artifacts/compose.full.yaml
          cp CHANGELOG.md release-artifacts/CHANGELOG.md

          # Create deployment guide
          cat > release-artifacts/DEPLOYMENT.md << 'EOF'
          # Deployment Guide

          ## Quick Start

          1. Download the release artifacts:
             - `r2r.toml` - R2R configuration
             - `compose.full.yaml` - Docker Compose configuration

          2. Deploy to production:
             ```bash
             # Upload configuration
             gcloud compute scp r2r.toml r2r-vm-new:/home/laptop/r2r-deploy/user_configs/r2r.toml --zone=us-central1-a

             # Restart R2R
             gcloud compute ssh r2r-vm-new --zone=us-central1-a \
               --command="cd /home/laptop/r2r-deploy && docker compose restart r2r"
             ```

          3. Verify deployment:
             ```bash
             gcloud compute ssh r2r-vm-new --zone=us-central1-a \
               --command="curl -s http://localhost:7272/v3/health"
             ```

          ## Rollback

          If issues occur, restore the previous configuration from backup:

          ```bash
          gcloud compute ssh r2r-vm-new --zone=us-central1-a --command="
            cp /home/laptop/r2r-deploy/user_configs/r2r.toml.backup-* \
               /home/laptop/r2r-deploy/user_configs/r2r.toml &&
            cd /home/laptop/r2r-deploy && docker compose restart r2r
          "
          ```

          For more details, see:
          - `.claude/rules/deployment.md` - Full deployment procedures
          - `CLAUDE.md` - Configuration workflow
          EOF

          ls -lh release-artifacts/
          echo "âœ… Release artifacts prepared"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body_path: release-artifacts/CHANGELOG.md
          files: |
            release-artifacts/r2r.toml
            release-artifacts/compose.full.yaml
            release-artifacts/DEPLOYMENT.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        env:
          TAG: ${{ steps.tag.outputs.tag }}
        run: |
          echo "## ðŸŽ‰ Release $TAG Created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- r2r.toml" >> $GITHUB_STEP_SUMMARY
          echo "- compose.full.yaml" >> $GITHUB_STEP_SUMMARY
          echo "- DEPLOYMENT.md" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Changelog Preview" >> $GITHUB_STEP_SUMMARY
          head -20 release-artifacts/CHANGELOG.md >> $GITHUB_STEP_SUMMARY
