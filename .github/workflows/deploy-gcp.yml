name: Deploy to GCP

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging

env:
  GCP_VM_USER: laptop
  GCP_VM_IP: ${{ secrets.GCP_VM_IP }}
  DEPLOY_PATH: /home/laptop/r2r-deploy

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Set up SSH
        env:
          SSH_KEY_BASE64: ${{ secrets.GCP_SSH_PRIVATE_KEY_BASE64 }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY_BASE64" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $GCP_VM_IP >> ~/.ssh/known_hosts

      - name: Verify VM is reachable
        run: |
          ssh -o StrictHostKeyChecking=no \
            $GCP_VM_USER@$GCP_VM_IP \
            "echo 'VM is reachable'"

      - name: Restart R2R service
        run: |
          ssh -o StrictHostKeyChecking=no \
            $GCP_VM_USER@$GCP_VM_IP \
            "cd $DEPLOY_PATH && docker compose restart r2r"

      - name: Wait for service restart
        run: |
          sleep 75

      - name: Verify deployment
        run: |
          for i in {1..8}; do
            echo "Health check attempt $i/8..."
            if ssh -o StrictHostKeyChecking=no $GCP_VM_USER@$GCP_VM_IP "curl -sf http://localhost:7272/v3/health"; then
              echo "Deployment successful"
              exit 0
            fi
            if [ $i -lt 8 ]; then
              echo "Service not ready, waiting 15s..."
              sleep 15
            fi
          done
          echo "Health check failed after 8 attempts"
          ssh -o StrictHostKeyChecking=no \
            $GCP_VM_USER@$GCP_VM_IP \
            "docker logs r2r-deploy-r2r-1 --tail=100"
          exit 1

      - name: Check for errors in logs
        run: |
          ssh -o StrictHostKeyChecking=no \
            $GCP_VM_USER@$GCP_VM_IP \
            "docker logs r2r-deploy-r2r-1 --tail=50 | grep -i error || true"
