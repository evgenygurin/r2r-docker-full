name: Deploy to GCP

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging

  push:
    branches:
      - main
    paths:
      - 'docker/user_configs/r2r.toml'

env:
  GCP_VM_USER: laptop
  GCP_VM_IP: ${{ secrets.GCP_VM_IP }}
  DEPLOY_PATH: /home/laptop/r2r-deploy

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GCP_SSH_PRIVATE_KEY }}" > ~/.ssh/gcp_key
          chmod 600 ~/.ssh/gcp_key
          ssh-keyscan -H $GCP_VM_IP >> ~/.ssh/known_hosts

      - name: Verify VM is reachable
        run: |
          ssh -i ~/.ssh/gcp_key \
            -o StrictHostKeyChecking=no \
            $GCP_VM_USER@$GCP_VM_IP \
            "echo 'âœ… VM is reachable'"

      - name: Validate TOML before deployment
        run: |
          pip install toml
          python -c "import toml; toml.load('docker/user_configs/r2r.toml')"
          echo "âœ… TOML validation passed"

      - name: Check for secrets in config
        run: |
          python3 << 'EOF'
          import re
          import sys

          with open('docker/user_configs/r2r.toml', 'r') as f:
              content = f.read()

          pattern = r'(password|secret|key|token)\s*=\s*["\'](.+?)["\']'
          matches = re.finditer(pattern, content, re.IGNORECASE)

          hardcoded = []
          for match in matches:
              value = match.group(2)
              if not value.startswith('${') and value != '':
                  hardcoded.append(match.group(0))

          if hardcoded:
              print("âŒ ERROR: Found hardcoded secrets")
              for secret in hardcoded:
                  print(f"  - {secret}")
              sys.exit(1)

          print("âœ… No hardcoded secrets")
          EOF

      - name: Create backup on server
        run: |
          ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
            "cp $DEPLOY_PATH/user_configs/r2r.toml \
                $DEPLOY_PATH/user_configs/r2r.toml.backup-\$(date +%Y%m%d-%H%M%S)"

      - name: Upload configuration
        run: |
          scp -i ~/.ssh/gcp_key \
            docker/user_configs/r2r.toml \
            $GCP_VM_USER@$GCP_VM_IP:$DEPLOY_PATH/user_configs/r2r.toml

      - name: Restart R2R service
        run: |
          ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
            "cd $DEPLOY_PATH && docker compose restart r2r"

      - name: Wait for service restart
        run: |
          sleep 30

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
            "curl -f http://localhost:7272/v3/health" || {
              echo "âŒ Health check failed"
              ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
                "docker logs r2r-deploy-r2r-1 --tail=100"
              exit 1
            }
          echo "âœ… Deployment successful"

      - name: Check for errors in logs
        run: |
          ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
            "docker logs r2r-deploy-r2r-1 --tail=50 | grep -i error || true"

      - name: Rollback on failure
        if: failure()
        run: |
          echo "ðŸ”„ Rolling back deployment..."
          ssh -i ~/.ssh/gcp_key $GCP_VM_USER@$GCP_VM_IP \
            "LATEST_BACKUP=\$(ls -t $DEPLOY_PATH/user_configs/r2r.toml.backup-* | head -1) && \
             if [ -f \"\$LATEST_BACKUP\" ]; then \
               cp \"\$LATEST_BACKUP\" $DEPLOY_PATH/user_configs/r2r.toml && \
               cd $DEPLOY_PATH && docker compose restart r2r && \
               echo 'âœ… Rollback completed'; \
             else \
               echo 'âŒ No backup found for rollback'; \
               exit 1; \
             fi"
